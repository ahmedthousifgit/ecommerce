<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, shrink-to-fit=no"
  />
  <link
    href="https://fonts.googleapis.com/css?family=Montserrat:300,400,500,600,700"
    rel="stylesheet"
  />
  <link
    href="https://fonts.googleapis.com/css?family=Rokkitt:100,300,400,700"
    rel="stylesheet"
  />
  

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Animate.css -->
  <link rel="stylesheet" href="/css/animate.css" />
  <!-- Icomoon Icon Fonts-->
  <link rel="stylesheet" href="/css/icomoon.css" />
  <!-- Ion Icon Fonts-->
  <link rel="stylesheet" href="/css/ionicons.min.css" />
  <!-- Bootstrap  -->
  <link rel="stylesheet" href="/css/bootstrap.min.css" />

  <!-- Magnific Popup -->
  <link rel="stylesheet" href="/css/magnific-popup.css" />

  <!-- Flexslider  -->
  <link rel="stylesheet" href="/css/flexslider.css" />

  <!-- Owl Carousel -->
  <link rel="stylesheet" href="/css/owl.carousel.min.css" />
  <link rel="stylesheet" href="/css/owl.theme.default.min.css" />

  <!-- Date Picker -->
  <link rel="stylesheet" href="/css/bootstrap-datepicker.css" />
  <!-- Flaticons  -->
  <link rel="stylesheet" href="/fonts/flaticon/font/flaticon.css" />

  <!-- Theme style  -->
  <link rel="stylesheet" href="/css/style.css" />
</head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
<style>
  .icon-hover-primary:hover {
    border-color: #3b71ca !important;
    background-color: white !important;
  }

  .icon-hover-primary:hover i {
    color: #3b71ca !important;
  }

  .icon-hover-danger:hover {
    border-color: #dc4c64 !important;
    background-color: white !important;
  }

  .icon-hover-danger:hover i {
    color: #dc4c64 !important;
  }

  .boxed label {
    display: inline-block;
    width: 100%;
    margin-top: 20px;
    padding: 10px;
    border: solid 2px #ccc;
    transition: all 0.3s;
  }

  .boxed input[type="radio"] {
    display: none;
  }

  .boxed input[type="radio"]:checked + label {
    border: solid 2px rgb(15, 103, 218);
    background-color: #bad5ff;
  }
  :root {
    --card-line-height: 1.2em;
    --card-padding: 1em;
    --card-radius: 0.5em;
    --color-green: #558309;
    --color-gray: #e2ebf6;
    --color-dark-gray: #c4d1e1;
    --radio-border-width: 2px;
    --radio-size: 1.5em;
  }

  body {
    background-color: #f2f8ff;
    color: #263238;
    font-family: "Noto Sans", sans-serif;
    margin: 0;
    padding: 2em 6vw;
  }

  .grid {
    display: grid;
    grid-gap: var(--card-padding);
    margin: 0 auto;
    max-width: 60em;
    padding: 0;

    @media (min-width: 42em) {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  .card {
    background-color: #fff;
    border-radius: var(--card-radius);
    position: relative;

    &:hover {
      box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.15);
    }
  }

  .radio {
    font-size: inherit;
    margin: 0;
    position: absolute;
    right: calc(var(--card-padding) + var(--radio-border-width));
    top: calc(var(--card-padding) + var(--radio-border-width));
  }

  @supports (-webkit-appearance: none) or (-moz-appearance: none) {
    .radio {
      -webkit-appearance: none;
      -moz-appearance: none;
      background: #fff;
      border: var(--radio-border-width) solid var(--color-gray);
      border-radius: 50%;
      cursor: pointer;
      height: var(--radio-size);
      outline: none;
      transition: background 0.2s ease-out, border-color 0.2s ease-out;
      width: var(--radio-size);

      &::after {
        border: var(--radio-border-width) solid #fff;
        border-top: 0;
        border-left: 0;
        content: "";
        display: block;
        height: 0.75rem;
        left: 25%;
        position: absolute;
        top: 50%;
        transform: rotate(45deg) translate(-50%, -50%);
        width: 0.375rem;
      }

      &:checked {
        background: var(--color-green);
        border-color: var(--color-green);
      }
    }

    .card:hover .radio {
      border-color: var(--color-dark-gray);

      &:checked {
        border-color: var(--color-green);
      }
    }
  }

  .plan-details {
    border: var(--radio-border-width) solid var(--color-gray);
    border-radius: var(--card-radius);
    cursor: pointer;
    display: flex;
    flex-direction: column;
    padding: var(--card-padding);
    transition: border-color 0.2s ease-out;
  }

  .card:hover .plan-details {
    border-color: var(--color-dark-gray);
  }

  .radio:checked ~ .plan-details {
    border-color: var(--color-green);
  }

  .radio:focus ~ .plan-details {
    box-shadow: 0 0 0 2px var(--color-dark-gray);
  }

  .radio:disabled ~ .plan-details {
    color: var(--color-dark-gray);
    cursor: default;
  }

  .radio:disabled ~ .plan-details .plan-type {
    color: var(--color-dark-gray);
  }

  .card:hover .radio:disabled ~ .plan-details {
    border-color: var(--color-gray);
    box-shadow: none;
  }

  .card:hover .radio:disabled {
    border-color: var(--color-gray);
  }

  .plan-type {
    color: var(--color-green);
    font-size: 1.5rem;
    font-weight: bold;
    line-height: 1em;
  }

  .plan-cost {
    font-size: 2.5rem;
    font-weight: bold;
    padding: 0.5rem 0;
  }

  .slash {
    font-weight: normal;
  }

  .plan-cycle {
    font-size: 2rem;
    font-variant: none;
    border-bottom: none;
    cursor: inherit;
    text-decoration: none;
  }

  .hidden-visually {
    border: 0;
    clip: rect(0, 0, 0, 0);
    height: 1px;
    margin: -1px;
    overflow: hidden;
    padding: 0;
    position: absolute;
    white-space: nowrap;
    width: 1px;
  }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>

<!-- cart + summary -->

<%-include('../partials/header')%> <%-include('../partials/nav') %>
<section class="bg-light my-5">
  <div class="container">
    <div class="row">
      <!-- cart -->
      <div class="col-lg-9">
        <div class="card border shadow-0">
          <div class="m-4">
            <h1
              style="
                font-family: system-ui, -apple-system, BlinkMacSystemFont,
                  'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans',
                  'Helvetica Neue', sans-serif;
                font-weight: bolder;
              "
              class="card-title mb-4"
            >
              Select Address
            </h1>
            <a
              href="/checkout-address"
              class="btn btn-info"
              style="margin-left: 85%"
              >Add Address</a
            >

            <!-- <form class="boxed" action="/checkout" method="post"> -->
            <form
              class="boxed"
              id="checkoutForm"
              action="#"
              onsubmit="return false"
            >
              <% user.addresses.forEach(address => { %>
              <input
                type="radio"
                id="<%= address._id %>"
                name="selectedAddress"
                class="address"
                required="true"
                value="<%= address._id %>"
                checked
              />
              <label for="<%= address._id %>" class="d-flex">
                <%= address.name %><br />
                <%= address.number %> &nbsp; &nbsp; <%= address.altNumber %><br />
                <%= address.pinCode %><br />
                <%= address.house %> <%= address.area %> <%= address.landmark %>
                <%= address.town %> <%= address.state %>
              </label>
              <% }); %>
              <br /><br />
              <h1
                style="
                  font-family: system-ui, -apple-system, BlinkMacSystemFont,
                    'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans',
                    'Helvetica Neue', sans-serif;
                  font-weight: bolder;
                "
                class="card-title mb-4"
              >
                Selected Products
              </h1>
              <% cart.forEach(item => { %>
              <div class="d-flex mb-3 border border-success rounded p-3">
                <input
                  type="hidden"
                  name="cart[<%= item.product._id %>]"
                  value="<%= item.product._id %>|<%= item.quantity %>"
                />
                <img
                  class="img-fluid"
                  width="100px"
                  src="/uploads/products/<%= item.product.image[0] %>"
                  alt="product-img"
                />
                <p for="name" class="ms-4">
                  <%= item.product.name %> <br />
                  Price: â‚¹<%= item.product.salePrice %> <br />
                  Quantity: <%= item.quantity %>
                </p>
              </div>
              <!-- Add more details as needed -->
              <% }); %>

              <br /><br />

              <h2>Select Payment method</h2>

              <div class="grid mb-0">
                <label class="card">
                  <input
                    name="paymentMethod"
                    class="radio payment"
                    type="radio"
                    value="cod"
                    checked
                  />
                  <span class="plan-details">
                    <img src="/images/cod.jpeg" alt="cod-img" />
                  </span>
                </label>
                <label class="card">
                  <input
                    name="paymentMethod"
                    class="radio payment"
                    type="radio"
                    value="razorpay"
                  />
                  <span class="plan-details">
                    <img
                      src="https://tse4.mm.bing.net/th?id=OIP.n7Hfo49CKkQWz6wM62j7HgHaFj&pid=Api&P=0&h=180"
                      alt="razorpay-img"
                    />
                  </span>
                </label>
              </div>

              <%if(parseInt(totalPrice)<=parseInt(userData.wallet)){%>
              <label class="" >
                <input name="paymentMethod" class="radio payment" type="radio" value="wallet"  checked>
                <span class="plan-details">
                  <h3>Use Wallet</h3>
                </span>
              </label>
              <% } %>

             
            </form>
          </div>
        </div>
      </div>

      <!-- coupon modal -->
      <div class="modal fade top" id="modalCoupon" tabindex="-1" aria-labelledby="myModalLabel" aria-hidden="true"
    data-bs-backdrop="true">
    <div class="modal-dialog modal-frame modal-top modal-notify modal-success" role="document">
      <!--Content-->
      <div class="modal-content">
        <!--Body-->
        <div class="modal-body">
          <h1></h1>
          <%if(coupons){%>
            <%for(i=0;i<coupons.length;i++){ %>
                <div class="row d-flex justify-content-center align-items-center border rounded">
                  <div class="col-12 col-md-12 d-flex">
                    <div class="code-container col-3 col-md-3 d-flex align-items-center">
                      <p>
                        <span class="badge" id="couponCode<%= i %>" style="color: black;">
                          <%= coupons[i].name %>
                        </span>
                        <input type="text" value="<%= coupons[i].code %>" id="myInput<%= i %>" style="border: none;" readonly>
  
                      </p>
                    </div>
                    <div class="content-copy-container col-9 col-md-9 d-flex align-items-center">
                      <p class="pt-3 mx-4">
                        <strong class="ml-5"> &#8377;<%= coupons[i].offerPrice %> discount</strong>.
                      </p>
                      <button type="button" class="btn btn-success copy-button ms-auto" data-index="<%= i %>"
                        onclick="myFunction('<%= i %>')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-minus" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M5.5 9.5A.5.5 0 0 1 6 9h4a.5.5 0 0 1 0 1H6a.5.5 0 0 1-.5-.5z"/>
                            <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
                            <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/>
                          </svg>
                      </button>
                    </div>
                  </div>
                </div>
              <% } %>
              <% } %>
  
              <div class="close-container d-flex justify-content-end mt-2">
                <button type="button" class="btn btn-outline-success" data-bs-dismiss="modal">No, thanks</button>
              </div>
        </div>
      </div>
      <!--/.Content-->
    </div>
  </div>
      <!-- coupon modal ends -->




      <div class="col-lg-3">
        <!-- coupons -->
      <% if(coupons){ %>
        <div class="card mb-3 border shadow-0">
          <div class="card-body">
            <form>
              <button type="button" id="availableCoupon" class="btn btn-outline-primary mt-2" data-bs-toggle="modal"
              data-bs-target="#modalCoupon">Available Coupons</button>
              <div class="form-group">
                <label class="form-label">Have coupon?</label>
                <div class="input-group">
                  <input type="text" class="form-control border mb-1" id="coupon" name="coupon" placeholder="Coupon code" />
                  <a onclick="applyCoupon(' <%= totalPrice %>','<%=userData.wallet%>')" id="applyButton" class="btn btn-light border">Apply</a>
                </div>
              </div>
              <p id="errorMessage" style="color: red;"></p>
            </form>
          </div>
        </div>
        <% }else{ %>
          <input type="hidden" class="form-control border" id="coupon" name="coupon" value="0" placeholder="Coupon code" />
          <%}%>
          <!-- coupons end -->
          
          <div class="card shadow-0 border">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                
              <p class="mb-2">Total price:</p>
              
              <input
                type="hidden"
                name="totalPrice"
                id="totalPriceInput"
                value="<%= totalPrice %>"
              />
             
              <p class="mb-2" id="displayedTotal">â‚¹ <b><%=totalPrice.toFixed(2) %> </b></p>
            </div>
            <div class="d-flex justify-content-between">
              <p class="mb-2">Discount:</p>
              <p class="mb-2 text-success" id="discount">0</p>
          </div>
            
            
            <hr />
            <div class="d-flex justify-content-between">
              <p class="mb-2">Total price:</p>

              <p class="mb-2 fw-bold " id="gt"> 
                <%= totalPrice %>
                      </p>
                 
          </div>

          </div>
          <div class="mt-3">
            <button
              type="submit"
              id="completeCheckoutBtn"
              class="btn btn-success w-100 shadow-0 mb-2"
            >
              complete checkout
            </button>
            <!-- <a href="#" onclick="makePurchase('')" class="btn btn-success w-100 shadow-0 mb-2">complete checkout </a>   -->
            <a href="/product-details" class="btn btn-light w-100 border mt-2">
              Back to shop
            </a>

            <input type="hidden" id="walletAdded" value="0" />
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
<!-- cart + summary -->
<section></section>
<!-- Recommended -->

<%-include('../partials/footer')%>

<script src="/js/jquery.min.js"></script>
<!-- popper -->
<script src="/js/popper.min.js"></script>
<!-- bootstrap 4.1 -->
<script src="/js/bootstrap.min.js"></script>
<!-- jQuery easing -->
<script src="/js/jquery.easing.1.3.js"></script>
<!-- Waypoints -->
<script src="/js/jquery.waypoints.min.js"></script>
<!-- Flexslider -->
<script src="/js/jquery.flexslider-min.js"></script>
<!-- Owl carousel -->
<script src="/js/owl.carousel.min.js"></script>
<!-- Magnific Popup -->
<script src="/js/jquery.magnific-popup.min.js"></script>
<script src="js/magnific-popup-options.js"></script>
<!-- Date Picker -->
<script src="/js/bootstrap-datepicker.js"></script>
<!-- Stellar Parallax -->
<script src="/js/jquery.stellar.min.js"></script>
<!-- Main -->
<script src="/js/main.js"></script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>


<script>
let coupon;
let statusFlag = false;
function applyCoupon(total, wallet) {
  let errorMessage = document.querySelector('#errorMessage');
   coupon = document.getElementById('coupon').value;

  fetch('/apply-coupon', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      coupon,
      total,
    }),
  })
  .then(response => {
    console.log('b4 parsing',response)
    const res = response.json()
    if(response.status === 201){
      console.log('inside if')
      statusFlag = true;
    }else{
      statusFlag=false
    }
    return res;  
  })
  .then(response => {
    
    console.log('after parsing',response,statusFlag);
    console.log(response.status);
    if (statusFlag) {
      
      errorMessage.innerHTML = response.message;
      setTimeout(() => {
        errorMessage.innerHTML = '';
      }, 2000);
    } else{
      
      document.getElementById('coupon').readOnly = true;
      document.getElementById('availableCoupon').style.display = 'none';
      document.getElementById('applyButton').disabled = true;
      const gtElement = document.getElementById('gt');
      const discountElement = document.getElementById('discount');

      // Update the displayed total with the discount
      const gt = parseFloat(gtElement.innerHTML);
      gtElement.innerHTML = ` ${(gt - parseFloat(response.offerPrice)).toFixed(2)}`;
      // Update the discount
      const discount = parseFloat(discountElement.innerHTML);
      discountElement.innerHTML = (discount + response.offerPrice).toFixed(2);

      const tot = parseFloat(gtElement.innerHTML);
      if (tot >= wallet) {
        // Enable the button
        document.getElementById('walletButton').disabled = false;
        document.getElementById('walletButton').innerHTML = 'Use wallet';
      } else {
        // Disable the button and display "Insufficient Funds"
        document.getElementById('walletButton').disabled = true;
        document.getElementById('walletButton').innerHTML = 'Insufficient Funds';
      }
    }
  })
  .catch(error => {
    console.error(error);
    // Handle errors as needed
  });
}



      
  function myFunction(index) {
  var copyText = document.getElementById("myInput" + index);
  copyText.select();
  copyText.setSelectionRange(0, 99999)
  navigator.clipboard.writeText(copyText.value)
    .then(function() {
      console.log("Text copied to clipboard: " + copyText.value);
            var noThanksButton = document.querySelector('.close-container button');
      if (noThanksButton) {
        noThanksButton.click();
      }
    })
    .catch(function(err) {
      console.error("Failed to copy text: " + err);
    });
  }

</script>

<script>
   const gtElement = document.getElementById('gt');
  const handlePaymentSelection = (selectedPaymentMethod) => {
    const paymentMethods = document.querySelectorAll(
      'input[name="paymentMethod"]'
    );
    paymentMethods.forEach((method) => {
      const span = method.parentElement.querySelector(".plan-details");
      if (method.value === selectedPaymentMethod) {
        span.classList.add("selected-payment");
      } else {
        span.classList.remove("selected-payment");
      }
    });
  };

  document
    .getElementById("completeCheckoutBtn")
    .addEventListener("click", async () => {
      const billingAddress = document.querySelector(
        'input[name="selectedAddress"]:checked'
      );
      const paymentMethod = document.querySelector(
        'input[name="paymentMethod"]:checked'
      ).value;

      if (!billingAddress) {
        alert("Please select an address or add a product to the cart");
        return;
      }
      let discountTotal = gtElement.innerText
      coupon = document.getElementById('coupon').value
      console.log(coupon);
      if(coupon.length!==0){
        couponCode = coupon
      }else{
        couponCode= null
      }

      if (paymentMethod === "razorpay") {
        // Handle Razorpay payment
        const response = await fetch("/razorpay-order", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            selectedAdd: billingAddress.value,
            discountTotal,
            couponCode
            
          }),
        });

        const data = await response.json();
        console.log(data);
     

      

        if (data.success) {
          const options = {
            key: "rzp_test_mu3Z5SNU9tR58R",
            amount: data.order.amount,
            currency: "INR",
            name: "Shoes.in",
            description: "Payment for Your Order",
            order_id: data.order.id,
            handler: async function (response) {
              // Handle successful payment response here
              console.log("Payment successful:", response);
              if (response.razorpay_payment_id) {
                // Move the order creation logic here
                console.log(
                  "Razorpay payment ID available. Proceeding to order creation..."
                );

                const createOrderResponse = await fetch("/create-order", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({
                    selectedAdd: billingAddress.value,
                    totalPrice: data.order.amount/100
                  }),
                });

                const orderData = await createOrderResponse.json();

                if (orderData.success) {
                  console.log("Order created successfully");
                  // Redirect to order confirmation page or any other desired action
                  window.location.href = "/order-list";
                } else {
                  // Handle error in order creation
                  console.log("error found");
                  console.error("Error in order creation:", orderData.error);
                }
              }
            },
            prefill: {
              name: "<%= user.name %>",
              email: "<%= user.email %>",
            },
            theme: {
              color: "#3399cc",
            },
          };

          const rzp = new Razorpay(options);
          rzp.open();
        } else {
          // Handle error in Razorpay order creation
          console.error("Error in Razorpay order creation:", data.error);
        }
      
      } else if (paymentMethod === "cod") {
        // Handle Cash on Delivery (COD) payment
        try {
          const response = await fetch("/checkout", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              selectedAdd: billingAddress.value,
              discountTotal,
              couponCode
            }),
          });

          const data = await response.json();

          if (data.success) {
            await Swal.fire({
              title: "Order Confirmed!",
              text: "Order Successful. Waiting for response!",
              icon: "success",
            });
            window.location.href = "/order-list";
          } else {
            // Handle error in checkout
            console.error("Error in checkout:", data.error);
          }
        } catch (error) {
          console.error("Error in checkout:", error);
        }
      }
      else if (paymentMethod === "wallet") {
        // Handle Cash on Delivery (COD) payment
        try {
          const response = await fetch("/walletPayment", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              selectedAdd: billingAddress.value,
              discountTotal,
              couponCode
            }),
          });

          const data = await response.json();

          if (data.success) {
            await Swal.fire({
              title: "Order Confirmed!",
              text: "Order Successful. Waiting for response!",
              icon: "success",
            });
            window.location.href = "/order-list";
          } else {
            // Handle error in checkout
            console.error("Error in checkout:", data.error);
          }
        } catch (error) {
          console.error("Error in checkout:", error);
        }
      }
    });


    
</script>