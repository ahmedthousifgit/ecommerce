<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, shrink-to-fit=no"
  />
  <link
    href="https://fonts.googleapis.com/css?family=Montserrat:300,400,500,600,700"
    rel="stylesheet"
  />
  <link
    href="https://fonts.googleapis.com/css?family=Rokkitt:100,300,400,700"
    rel="stylesheet"
  />

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Animate.css -->
  <link rel="stylesheet" href="/css/animate.css" />
  <!-- Icomoon Icon Fonts-->
  <link rel="stylesheet" href="/css/icomoon.css" />
  <!-- Ion Icon Fonts-->
  <link rel="stylesheet" href="/css/ionicons.min.css" />
  <!-- Bootstrap  -->
  <link rel="stylesheet" href="/css/bootstrap.min.css" />

  <!-- Magnific Popup -->
  <link rel="stylesheet" href="/css/magnific-popup.css" />

  <!-- Flexslider  -->
  <link rel="stylesheet" href="/css/flexslider.css" />

  <!-- Owl Carousel -->
  <link rel="stylesheet" href="/css/owl.carousel.min.css" />
  <link rel="stylesheet" href="/css/owl.theme.default.min.css" />

  <!-- Date Picker -->
  <link rel="stylesheet" href="/css/bootstrap-datepicker.css" />
  <!-- Flaticons  -->
  <link rel="stylesheet" href="/fonts/flaticon/font/flaticon.css" />

  <!-- Theme style  -->
  <link rel="stylesheet" href="/css/style.css" />
</head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
<style>
  .icon-hover-primary:hover {
    border-color: #3b71ca !important;
    background-color: white !important;
  }

  .icon-hover-primary:hover i {
    color: #3b71ca !important;
  }

  .icon-hover-danger:hover {
    border-color: #dc4c64 !important;
    background-color: white !important;
  }

  .icon-hover-danger:hover i {
    color: #dc4c64 !important;
  }

  .boxed label {
    display: inline-block;
    width: 100%;
    margin-top: 20px;
    padding: 10px;
    border: solid 2px #ccc;
    transition: all 0.3s;
  }

  .boxed input[type="radio"] {
    display: none;
  }

  .boxed input[type="radio"]:checked + label {
    border: solid 2px rgb(15, 103, 218);
    background-color: #bad5ff;
  }

  :root {
    --card-line-height: 1.2em;
    --card-padding: 1em;
    --card-radius: 0.5em;
    --color-green: #558309;
    --color-gray: #e2ebf6;
    --color-dark-gray: #c4d1e1;
    --radio-border-width: 2px;
    --radio-size: 1.5em;
  }

  body {
    background-color: #f2f8ff;
    color: #263238;
    font-family: "Noto Sans", sans-serif;
    margin: 0;
    padding: 2em 6vw;
  }

  .grid {
    display: grid;
    grid-gap: let(--card-padding);
    margin: 0 auto;
    max-width: 60em;
    padding: 0;

    @media (min-width: 42em) {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  .card {
    background-color: #fff;
    border-radius: let(--card-radius);
    position: relative;

    &:hover {
      box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.15);
    }
  }

  .radio {
    font-size: inherit;
    margin: 0;
    position: absolute;
    right: calc(let(--card-padding) + let(--radio-border-width));
    top: calc(let(--card-padding) + let(--radio-border-width));
  }

  @supports (-webkit-appearance: none) or (-moz-appearance: none) {
    .radio {
      -webkit-appearance: none;
      -moz-appearance: none;
      background: #fff;
      border: let(--radio-border-width) solid let(--color-gray);
      border-radius: 50%;
      cursor: pointer;
      height: let(--radio-size);
      outline: none;
      transition: background 0.2s ease-out, border-color 0.2s ease-out;
      width: let(--radio-size);

      &::after {
        border: let(--radio-border-width) solid #fff;
        border-top: 0;
        border-left: 0;
        content: "";
        display: block;
        height: 0.75rem;
        left: 25%;
        position: absolute;
        top: 50%;
        transform: rotate(45deg) translate(-50%, -50%);
        width: 0.375rem;
      }

      &:checked {
        background: let(--color-green);
        border-color: let(--color-green);
      }
    }

    .card:hover .radio {
      border-color: let(--color-dark-gray);

      &:checked {
        border-color: let(--color-green);
      }
    }
  }

  .plan-details {
    border: let(--radio-border-width) solid let(--color-gray);
    border-radius: let(--card-radius);
    cursor: pointer;
    display: flex;
    flex-direction: column;
    padding: let(--card-padding);
    transition: border-color 0.2s ease-out;
  }

  .card:hover .plan-details {
    border-color: let(--color-dark-gray);
  }

  .radio:checked ~ .plan-details {
    border-color: let(--color-green);
  }

  .radio:focus ~ .plan-details {
    box-shadow: 0 0 0 2px let(--color-dark-gray);
  }

  .radio:disabled ~ .plan-details {
    color: let(--color-dark-gray);
    cursor: default;
  }

  .radio:disabled ~ .plan-details .plan-type {
    color: let(--color-dark-gray);
  }

  .card:hover .radio:disabled ~ .plan-details {
    border-color: let(--color-gray);
    box-shadow: none;
  }

  .card:hover .radio:disabled {
    border-color: let(--color-gray);
  }

  .plan-type {
    color: let(--color-green);
    font-size: 1.5rem;
    font-weight: bold;
    line-height: 1em;
  }

  .plan-cost {
    font-size: 2.5rem;
    font-weight: bold;
    padding: 0.5rem 0;
  }

  .slash {
    font-weight: normal;
  }

  .plan-cycle {
    font-size: 2rem;
    font-letiant: none;
    border-bottom: none;
    cursor: inherit;
    text-decoration: none;
  }

  .hidden-visually {
    border: 0;
    clip: rect(0, 0, 0, 0);
    height: 1px;
    margin: -1px;
    overflow: hidden;
    padding: 0;
    position: absolute;
    white-space: nowrap;
    width: 1px;
  }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>

<!-- cart + summary -->

<%-include('../partials/header')%> <%-include('../partials/nav') %>
<section class="bg-light my-5">
  <div class="container">
    <div class="row">
      <!-- cart -->
      <div class="col-lg-9">
        <div class="card border shadow-0">
          <div class="m-4">
            <h1
              style="
                font-family: system-ui, -apple-system, BlinkMacSystemFont,
                  'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans',
                  'Helvetica Neue', sans-serif;
                font-weight: bolder;
              "
              class="card-title mb-4"
            >
              Select Address
            </h1>
            <a href="/add-address" class="btn btn-info" style="margin-left: 85%"
              >Add Address</a
            >

            <!-- <form class="boxed" action="/checkout" method="post"> -->
            <form
              class="boxed"
              id="checkoutForm"
              action="#"
              onsubmit="return false"
            >
              <% user.addresses.forEach(address => { %>
              <input
                type="radio"
                id="<%= address._id %>"
                name="selectedAddress"
                class="address"
                required="true"
                value="<%= address._id %>"
                checked
              />
              <label for="<%= address._id %>" class="d-flex">
                <%= address.name %><br />
                <%= address.number %> &nbsp; &nbsp; <%= address.altNumber %><br />
                <%= address.pinCode %><br />
                <%= address.house %> <%= address.area %> <%= address.landmark %>
                <%= address.town %> <%= address.state %>
              </label>
              <% }); %>
              <br /><br />
              <h1
                style="
                  font-family: system-ui, -apple-system, BlinkMacSystemFont,
                    'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans',
                    'Helvetica Neue', sans-serif;
                  font-weight: bolder;
                "
                class="card-title mb-4"
              >
                Selected Products
              </h1>
              <% cart.forEach(item => { %>
              <div class="d-flex mb-3 border border-success rounded p-3">
                <input
                  type="hidden"
                  name="cart[<%= item.product._id %>]"
                  value="<%= item.product._id %>|<%= item.quantity %>"
                />
                <img
                  class="img-fluid"
                  width="100px"
                  src="/uploads/products/<%= item.product.image[0] %>"
                  alt="product-img"
                />
                <p for="name" class="ms-4">
                  <%= item.product.name %> <br />
                  Price: â‚¹<%= item.product.salePrice %> <br />
                  Quantity: <%= item.quantity %>
                </p>
              </div>
              <!-- Add more details as needed -->
              <% }); %>

              <br /><br />

              <h2>Select Payment method</h2>

              <div class="grid mb-0">
                <label class="card">
                  <input
                    name="paymentMethod"
                    class="radio payment"
                    type="radio"
                    value="cod"
                    checked
                  />
                  <span class="plan-details">
                    <img src="/images/cod.jpeg" alt="cod-img" />
                  </span>
                </label>
              </div>
              <div class="col-lg-3">
                <div class="card shadow-0 border">
                 
                </div>
              </div>
              
            </form>
            
          </div>
        </div>
      </div>
      
      <div class="col-lg-3">
        <div class="card shadow-0 border">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <p class="mb-2">Total price:</p>
          <input
            type="hidden"
            name="totalPrice"
            value="<%= totalPrice %>"
          />
          <p class="mb-2">â‚¹ <b><%=totalPrice.toFixed(2) %> </b></p>
        </div>
        <hr />
      </div>
      <div class="mt-3">
        <button
          type="submit"
          id="completeCheckoutBtn"
          class="btn btn-success w-100 shadow-0 mb-2"
        >
          complete checkout
        </button>
        <!-- <a href="#" onclick="makePurchase('')" class="btn btn-success w-100 shadow-0 mb-2">complete checkout </a>   -->
        <a
          href="/product-details"
          class="btn btn-light w-100 border mt-2"
        >
          Back to shop
        </a>

        <input type="hidden" id="walletAdded" value="0" />
      </div>
    </div>
  </div>
    
    </div>
  </div>
</section>
<!-- cart + summary -->
<section></section>
<!-- Recommended -->

<%-include('../partials/footer')%>

<script src="/js/jquery.min.js"></script>
<!-- popper -->
<script src="/js/popper.min.js"></script>
<!-- bootstrap 4.1 -->
<script src="/js/bootstrap.min.js"></script>
<!-- jQuery easing -->
<script src="/js/jquery.easing.1.3.js"></script>
<!-- Waypoints -->
<script src="/js/jquery.waypoints.min.js"></script>
<!-- Flexslider -->
<script src="/js/jquery.flexslider-min.js"></script>
<!-- Owl carousel -->
<script src="/js/owl.carousel.min.js"></script>
<!-- Magnific Popup -->
<script src="/js/jquery.magnific-popup.min.js"></script>
<script src="js/magnific-popup-options.js"></script>
<!-- Date Picker -->
<script src="/js/bootstrap-datepicker.js"></script>
<!-- Stellar Parallax -->
<script src="/js/jquery.stellar.min.js"></script>
<!-- Main -->
<script src="/js/main.js"></script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
  document
    .getElementById("completeCheckoutBtn")
    .addEventListener("click", async () => {
      const billingAddress = document.querySelector(
        'input[name="selectedAddress"]:checked'
      );
      if (!billingAddress) {
        alert("please select an address");
        return;
      }
      const selectedAdd = billingAddress.value;
      try {
        fetch("/checkout", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            selectedAdd,
          }),
        })
          .then((response) => response.json())
          .then(async (data) => {
            await Swal.fire({
              title: "Order Confirmed!",
              text: "Order Successfull.Waiting for response!",
              icon: "success",
            });
            window.location.href = "/order-list";
            console.log("success", data);
          });
      } catch (error) {
        console.error("Error in checkout:", error);
      }
    });

    
</script>
